<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JPG Move Tool</title>
  <style>
    :root{
      --bg: #f5f5f7;
      --card: #ffffff;
      --text: #111;
      --muted: #6e6e73;
      --border: rgba(0,0,0,0.10);
      --shadow: 0 8px 24px rgba(0,0,0,0.08);
      --blue: #0a84ff;
      --blue-press: #0068d6;
      --danger: #d70015;
      --ok: #248a3d;
      --radius: 16px;
    }

    body{
      font-family: system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 22px;
    }

    .wrap{ max-width: 1060px; margin: 0 auto; }

    h1{
      margin: 0 0 14px;
      font-size: 34px;
      letter-spacing: -0.02em;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      margin-top: 14px;
      box-shadow: var(--shadow);
    }

    h2{
      margin: 0 0 10px;
      font-size: 20px;
      letter-spacing: -0.01em;
    }

    .muted{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.65;
    }

    .row{
      display:flex;
      gap: 12px;
      align-items:center;
      flex-wrap: wrap;
    }

    input[type="text"], textarea{
      width: min(860px, 100%);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 15px;
      background: #fff;
      outline: none;
    }
    textarea{
      min-height: 180px;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 13px;
      line-height: 1.55;
    }

    .btns{ display:flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; }

    button{
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 12px;
      padding: 10px 14px;
      font-size: 15px;
      cursor: pointer;
      transition: transform 0.02s ease, background 0.2s ease, border 0.2s ease;
    }
    button:active{ transform: translateY(1px); }

    .primary{
      background: var(--blue);
      border-color: transparent;
      color: #fff;
      font-weight: 600;
    }
    .primary:active{ background: var(--blue-press); }

    .pill{
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 14px;
    }

    .msg{
      margin-top: 10px;
      font-size: 14px;
    }
    .msg .ok{ color: var(--ok); font-weight: 700; }
    .msg .error{ color: var(--danger); font-weight: 700; }

    details{
      margin-top: 10px;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(0,0,0,0.02);
    }
    summary{
      cursor: pointer;
      color: var(--muted);
      font-size: 13px;
    }
    pre{
      white-space: pre-wrap;
      word-break: break-word;
      margin: 10px 0 0;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      color: #222;
    }

    dialog{
      border: none;
      border-radius: 16px;
      padding: 14px;
      width: min(760px, 92vw);
      box-shadow: var(--shadow);
    }
    dialog::backdrop{ background: rgba(0,0,0,0.35); }

    .grid{
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 8px;
      margin-top: 12px;
    }
    .chip{
      display:flex;
      gap: 8px;
      align-items:center;
      border: 1px solid var(--border);
      padding: 8px 10px;
      border-radius: 12px;
      background: #fff;
      user-select: none;
    }
    .dialog-actions{
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      margin-top: 12px;
    }

    .two{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 900px){
      .two{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>JPG Move Tool</h1>

  <!-- parent path -->
  <div class="card">
    <div class="row">
      <input id="parentPath" type="text" placeholder="Dropboxの親フォルダパス（例：/Users/xxx/wystyle Dropbox/案件）" />
    </div>
    <div class="muted" style="margin-top:8px;">
      ※ 親フォルダは Dropbox 同期フォルダ内のパスを入れてください。<br/>
      ※ 本ツールは <b>親直下</b> と <b>親直下の子フォルダ</b> を対象に処理します。
    </div>
  </div>

  <!-- ① PSD copy -->
  <div class="card">
    <h2>① PSDコピー（ファイル名末尾の数字で指定）</h2>
    <div class="muted">
      親フォルダ直下の <b>.psd</b> から、拡張子を除いたファイル名の末尾が一致するものをコピーし、<b>-600</b> を付けます。
    </div>

    <div class="row" style="margin-top:12px;">
      <button id="openPicker" class="pill">ファイル名選択（01〜35）</button>
      <span class="muted">チェックしてOK → 下の入力欄に反映</span>
    </div>

    <div class="row" style="margin-top:10px;">
      <input id="suffixCsv" type="text" placeholder="例：01,02,03,12" />
    </div>

    <div class="btns">
      <button id="psdPlanBtn">確認</button>
      <button id="psdExecBtn" class="primary">実行</button>
    </div>

    <div id="psdMsg" class="msg"></div>
    <details id="psdDetails" style="display:none;">
      <summary>詳細ログ（JSON）</summary>
      <pre id="psdOut"></pre>
    </details>
  </div>

  <!-- ② Move + delete + psd -->
  <div class="card">
    <h2>② データ移動（子フォルダ→jpg）＋元フォルダ削除＋親直下.psd→psd</h2>
    <div class="muted">
      親フォルダ内の「子フォルダ」を対象に、内部ファイルを <b>jpg</b> に集約してから元フォルダを削除します。<br/>
      さらに、親直下の <b>.psd</b> は <b>psd</b> フォルダへ移動します（親直下のみ）。
    </div>

    <div class="btns">
      <button id="movePlanBtn">確認</button>
      <button id="moveExecBtn" class="primary">実行</button>
    </div>

    <div id="moveMsg" class="msg"></div>
    <details id="moveDetails" style="display:none;">
      <summary>詳細ログ（JSON）</summary>
      <pre id="moveOut"></pre>
    </details>
  </div>

  <!-- ③ Text formatter -->
  <div class="card">
    <h2>③ テキスト整形（仕様表→所定フォーマット）</h2>
    <div class="muted">
      ルール：<b>■</b> と <b>：</b> の追加、<b>W/D/H→幅/奥行/高さ</b>、<b>mm→cm</b>（キーピッチ/キーストローク）、<b>保証期間</b>行削除、見出し行は <b>【】</b> で囲みます。最後に <b>【対応機種】</b> ブロックを追加します。
    </div>

    <div class="two" style="margin-top:12px;">
      <div>
        <div class="muted" style="margin:0 0 6px;">元テキスト</div>
        <textarea id="srcText" placeholder="ここに元テキストを貼り付け"></textarea>
      </div>
      <div>
        <div class="muted" style="margin:0 0 6px;">変更後テキスト</div>
        <textarea id="dstText" placeholder="ここに変換結果が出ます" readonly></textarea>
      </div>
    </div>

    <div class="btns">
      <button id="convertBtn" class="primary">変換</button>
      <button id="copyBtn">コピー</button>
      <span id="copyMsg" class="muted"></span>
    </div>

    <div id="textMsg" class="msg"></div>
  </div>

  <!-- Picker dialog -->
  <dialog id="pickerDialog">
    <h3 style="margin:0 0 8px; font-size:16px;">コピー対象の末尾（01〜35）をチェック</h3>
    <div class="grid" id="checkboxGrid"></div>
    <div class="dialog-actions">
      <button id="pickerCancel">キャンセル</button>
      <button id="pickerOk" class="primary">OK</button>
    </div>
  </dialog>

</div>

<script>
  function $(id){ return document.getElementById(id); }

  function jsonPretty(x){ return JSON.stringify(x, null, 2); }

  async function postJson(path, body){
    const res = await fetch(path, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(body),
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok){
      const msg = (data && data.error) ? data.error : `HTTP ${res.status}`;
      throw new Error(msg);
    }
    return data;
  }

  function getParentPath(){
    return $("parentPath").value.trim();
  }

  // ----------------------------
  // Picker: 01-35 checkboxes
  // ----------------------------
  const dialog = $("pickerDialog");
  const grid = $("checkboxGrid");

  function buildCheckboxes(){
    grid.innerHTML = "";
    for(let i=1;i<=35;i++){
      const label = String(i).padStart(2,"0");
      const wrap = document.createElement("label");
      wrap.className = "chip";
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.value = label;
      const span = document.createElement("span");
      span.textContent = label;
      wrap.appendChild(cb);
      wrap.appendChild(span);
      grid.appendChild(wrap);
    }
  }
  buildCheckboxes();

  $("openPicker").addEventListener("click", () => dialog.showModal());
  $("pickerCancel").addEventListener("click", () => dialog.close());
  $("pickerOk").addEventListener("click", () => {
    const checked = [...grid.querySelectorAll('input[type="checkbox"]:checked')].map(cb => cb.value);
    $("suffixCsv").value = checked.join(",");
    dialog.close();
  });

  // ----------------------------
  // ① PSD copy
  // ----------------------------
  $("psdPlanBtn").addEventListener("click", async () => {
    $("psdMsg").innerHTML = "";
    $("psdOut").textContent = "";
    $("psdDetails").style.display = "none";

    try{
      const parent_path = getParentPath();
      const suffix_csv = $("suffixCsv").value.trim();
      const data = await postJson("/psd_copy/plan", {parent_path, suffix_csv});

      // 人間向け表示
      const target = data.copy_count ?? 0;
      $("psdMsg").innerHTML = `<span class="ok">OK</span> 対象ファイル ${target}件`;

      // 詳細（折りたたみ）
      $("psdOut").textContent = jsonPretty(data);
      $("psdDetails").style.display = "block";
    }catch(e){
      $("psdMsg").innerHTML = `<span class="error">Error</span> ${e.message}`;
    }
  });

  $("psdExecBtn").addEventListener("click", async () => {
    $("psdMsg").innerHTML = "";
    $("psdOut").textContent = "";
    $("psdDetails").style.display = "none";

    try{
      const parent_path = getParentPath();
      const suffix_csv = $("suffixCsv").value.trim();

      if(!confirm("実行します。よろしいですか？")) return;

      const data = await postJson("/psd_copy/execute", {parent_path, suffix_csv});

      const target = data.plan?.copy_count ?? 0;
      const done = data.result?.copied_count ?? 0;
      $("psdMsg").innerHTML = `<span class="ok">Done</span> 対象ファイル ${target}件 / 処理済み ${done}件`;

      $("psdOut").textContent = jsonPretty(data);
      $("psdDetails").style.display = "block";
    }catch(e){
      $("psdMsg").innerHTML = `<span class="error">Error</span> ${e.message}`;
    }
  });

  // ----------------------------
  // ② Move + delete + psd
  // ----------------------------
  $("movePlanBtn").addEventListener("click", async () => {
    $("moveMsg").innerHTML = "";
    $("moveOut").textContent = "";
    $("moveDetails").style.display = "none";

    try{
      const parent_path = getParentPath();
      const data = await postJson("/move/plan", {parent_path});

      const targetFiles = data.move_to_jpg_count ?? 0;
      const targetDirs = data.delete_source_dirs_count ?? 0;
      const psdCount = data.move_parent_psd_count ?? 0;

      $("moveMsg").innerHTML =
        `<span class="ok">OK</span> 対象ファイル ${targetFiles}件 / 対象フォルダ ${targetDirs}件 / 親直下PSD ${psdCount}件`;

      $("moveOut").textContent = jsonPretty(data);
      $("moveDetails").style.display = "block";
    }catch(e){
      $("moveMsg").innerHTML = `<span class="error">Error</span> ${e.message}`;
    }
  });

  $("moveExecBtn").addEventListener("click", async () => {
    $("moveMsg").innerHTML = "";
    $("moveOut").textContent = "";
    $("moveDetails").style.display = "none";

    try{
      const parent_path = getParentPath();
      if(!confirm("実行します。よろしいですか？")) return;

      const data = await postJson("/move/execute", {parent_path});

      const moved = data.result?.moved_to_jpg_count ?? 0;
      const deleted = data.result?.deleted_dirs_count ?? 0;
      const psdMoved = data.result?.moved_parent_psd_count ?? 0;

      $("moveMsg").innerHTML =
        `<span class="ok">Done</span> 処理済みファイル ${moved}件 / 削除フォルダ ${deleted}件 / 親直下PSD移動 ${psdMoved}件`;

      $("moveOut").textContent = jsonPretty(data);
      $("moveDetails").style.display = "block";
    }catch(e){
      $("moveMsg").innerHTML = `<span class="error">Error</span> ${e.message}`;
    }
  });

  // ----------------------------
  // ③ Text convert
  // ----------------------------
  $("convertBtn").addEventListener("click", async () => {
    $("textMsg").innerHTML = "";
    try{
      const text = $("srcText").value || "";
      const data = await postJson("/text/convert", {text});
      $("dstText").value = data.output || "";
      $("textMsg").innerHTML = `<span class="ok">OK</span> 変換しました`;
    }catch(e){
      $("textMsg").innerHTML = `<span class="error">Error</span> ${e.message}`;
    }
  });

  $("copyBtn").addEventListener("click", async () => {
    $("copyMsg").textContent = "";
    try{
      const v = $("dstText").value || "";
      await navigator.clipboard.writeText(v);
      $("copyMsg").textContent = "コピーしました";
      setTimeout(() => $("copyMsg").textContent = "", 1200);
    }catch(e){
      $("copyMsg").textContent = "コピーできませんでした";
      setTimeout(() => $("copyMsg").textContent = "", 1200);
    }
  });
</script>
</body>
</html>